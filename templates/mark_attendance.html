<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6C63FF;
            --secondary-color: #8E7CFF;
            --text-color: #333;
            --light-bg: #F0F2F5;
            --card-bg: #fff;
            --border-color: #ddd;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
        }

        .container-fluid {
            padding: 2rem;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-section h3 {
            font-weight: 600;
            color: var(--primary-color);
        }

        .btn-done {
            background-color: var(--primary-color);
            border: none;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .btn-done:hover {
            background-color: var(--secondary-color);
        }

        .filter-row {
            margin-bottom: 2rem;
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
        }

        .form-select, .btn-primary {
            border-radius: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .table-responsive {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .attendance-table {
            margin-bottom: 0;
            border: none;
        }

        .attendance-table th, .attendance-table td {
            border-color: var(--light-bg);
        }

        .sticky-header th {
            position: sticky;
            top: 0;
            background: var(--light-bg);
            z-index: 2;
            font-weight: 600;
        }

        .student-name {
            text-align: left;
            padding-left: 1rem;
            font-weight: 500;
        }

        .present-cell { background-color: #D6EAD6; }   /* softer green */
        .absent-cell  { background-color: #F7DEDF; }   /* softer red */

        .attendance-checkbox {
            transform: scale(1.1);
            cursor: pointer;
        }

        .badge-placeholder { min-width: 58px; display: inline-block; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="header-section">
        <h3>Mark Attendance — {{ current_month_name if current_month_name else '' }} {{ current_year if current_year else '' }}</h3>
        <a href="/dashboard" class="btn btn-done text-white">Done</a>
    </div>

    <form method="get" action="/attendance" class="row g-2 filter-row">
        <div class="col-auto">
            {% if months_list %}
                <select name="month" class="form-select">
                    {% for m in months_list %}
                        <option value="{{ m.value }}" {% if m.value == current_month %}selected{% endif %}>{{ m.name }}</option>
                    {% endfor %}
                </select>
            {% else %}
                {% set month_names = ['January','February','March','April','May','June','July','August','September','October','November','December'] %}
                <select name="month" class="form-select">
                    {% for m in range(1,13) %}
                        <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>{{ month_names[m-1] }}</option>
                    {% endfor %}
                </select>
            {% endif %}
        </div>

        <div class="col-auto">
            {% if years_list %}
                <select name="year" class="form-select">
                    {% for y in years_list %}
                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            {% else %}
                {% set start_year = current_year - 5 if current_year else ( ( (now().year if now is defined else 2025) - 5 ) ) %}
                {% set end_year = current_year + 1 if current_year else ( (now().year if now is defined else 2025) + 1 ) %}
                <select name="year" class="form-select">
                    {% for y in range(end_year, start_year - 1, -1) %}
                        <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            {% endif %}
        </div>

        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </form>

    <div class="table-responsive" style="overflow-x:auto;">
        <table class="table table-bordered attendance-table">
            <thead class="table-light sticky-header">
                <tr>
                    <th style="min-width:240px">Student</th>
                    {% for d in range(1, num_days + 1) %}
                        <th>{{ d }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% if students %}
                    {% for student in students %}
                        <tr>
                            <td class="student-name">
                                <div>{{ student.name }}</div>
                            </td>

                            {% for d in range(1, num_days + 1) %}
                                {% set date_str = current_year ~ '-' ~ "%02d"|format(current_month) ~ '-' ~ "%02d"|format(d) %}
                                {% set status = attendance_map.get(student.id, {}).get(date_str) %}
                                <td class="{% if status and status|lower == 'present' %}present-cell{% elif status and status|lower == 'absent' %}absent-cell{% endif %}">
                                    <div class="d-flex flex-column align-items-center">
                                        <input
                                            type="checkbox"
                                            class="attendance-checkbox mb-1"
                                            data-student-id="{{ student.id }}"
                                            data-date="{{ date_str }}"
                                            {% if status and status|lower == 'present' %}checked{% endif %}
                                        >
                                        {% if status and status|lower == 'present' %}
                                            <span class="badge bg-success">Present</span>
                                        {% elif status and status|lower == 'absent' %}
                                            <span class="badge bg-danger">Absent</span>
                                        {% else %}
                                            <span class="badge bg-secondary badge-placeholder">—</span>
                                        {% endif %}
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{{ num_days + 1 }}" class="text-center text-muted">No students found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const boxes = document.querySelectorAll('.attendance-checkbox');

    function updateCellUI(cell, checked) {
        const badge = cell.querySelector('.badge');
        if (checked) {
            cell.classList.add('present-cell');
            cell.classList.remove('absent-cell');
            if (badge) { badge.textContent = 'Present'; badge.className = 'badge bg-success'; }
        } else {
            cell.classList.remove('present-cell');
            cell.classList.add('absent-cell');
            if (badge) { badge.textContent = 'Absent'; badge.className = 'badge bg-danger'; }
        }
    }

    boxes.forEach(function(cb) {
        cb.addEventListener('change', function() {
            const studentId = parseInt(this.dataset.studentId);
            const date = this.dataset.date;
            const isChecked = this.checked;
            const status = isChecked ? 'present' : 'absent';
            const cell = this.closest('td');

            // optimistic UI update
            updateCellUI(cell, isChecked);

            fetch('/attendance/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: studentId, date: date, status: status })
            })
            .then(r => r.json())
            .then(data => {
                if (!data || !data.success) {
                    alert('Failed to save attendance: ' + (data && data.error ? data.error : 'unknown'));
                    // revert UI
                    this.checked = !this.checked;
                    updateCellUI(cell, this.checked);
                }
            })
            .catch(() => {
                alert('Network error while saving attendance');
                // revert UI
                this.checked = !this.checked;
                updateCellUI(cell, this.checked);
            });
        });
    });
});
</script>
</body>
</html>